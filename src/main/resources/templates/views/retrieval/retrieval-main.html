<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
    <meta charset="UTF-8">
    <title>MeowWMS :: 출고관리</title>
    <th:block th:replace="common/fragments/index :: header-fragment"></th:block>
</head>

<body id="page-top">
<div id="wrapper">
    <th:block th:replace="common/fragments/index :: sidebar-fragment"></th:block>

    <div id="content-wrapper" class="d-flex flex-column">
        <th:block th:replace="common/fragments/index :: topbar-fragment"></th:block>

        <!-- Main Content -->
        <div id="content">
            <div class="container-fluid">

                <!-- Page Heading -->
                <h1 class="h3 mb-2 text-gray-800">출고 관리</h1>
                <p class="mb-4"></p>

                <!-- DataTales Example -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">출고 요청</h6>
                    </div>
                    <div class="card-body">
                        <div class="container-fluid">
                            <div class="row">
                                <!-- 제품 아이디 & 우편번호 -->
                                <div class="col-md-6">
                                    <label for="productId-input">제품 아이디</label>
                                    <input type="text" id="productId-input" class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label for="postcode-input">우편번호</label>
                                    <input type="text" id="postcode-input" class="form-control" style="max-width: 50%;">
                                </div>
                            </div>

                            <div class="row">
                                <!-- 상품 수량 & 도로명 주소 -->
                                <div class="col-md-6">
                                    <label for="quantity-input">상품 수량</label>
                                    <input type="number" id="quantity-input" class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label for="streetNameAddress-input">도로명주소</label>
                                    <input type="text" id="streetNameAddress-input" class="form-control">
                                </div>
                            </div>
                            <div class="row">
                                <!-- 출고 희망일 & 지번 주소 -->
                                <div class="col-md-6">
                                    <label for="expectedDate-input">출고 희망일</label>
                                    <input type="date" id="expectedDate-input" class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label for="streetNumberAddress-input">지번주소</label>
                                    <input type="text" id="streetNumberAddress-input" class="form-control">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                </div>
                                <div class="col-md-6">
                                    <label for="detailAddress-input">상세주소</label>
                                    <input type="text" id="detailAddress-input" class="form-control">
                                </div>
                            </div>

                            <div class="row">
                                <!-- 신청 버튼 -->
                                <div class="col-md-12" style="text-align: right; margin-top: 10px;"> <!-- 마진 추가 -->
                                    <button id="retrieval-register-button" class="btn btn-primary">신청</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DataTales Example -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">출고 지시서 리스트</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12" style="text-align: right;"> <!-- 전체 간격을 일정하게 열 맞춤 -->
                                <button id="vehicle-allocation-button" class="btn btn-warning" data-toggle="modal"
                                        data-target="#vehicleAllocationModal">배차 관리
                                </button>

                                <!-- 배차 관리 Modal -->
                                <div class="modal fade" id="vehicleAllocationModal" tabindex="-1" role="dialog"
                                     aria-labelledby="vehicleAllocationModalLabel" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="vehicleAllocationModalLabel">배차 관리</h5>

                                                <button type="button" class="close" data-dismiss="modal"
                                                        aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                <h6 style="text-align: center;">배차 가능 차량</h6>


                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                                                    닫기
                                                </button>

                                                <button type="button" id="choose-vehicle-button" class="btn btn-primary"
                                                        data-dismiss="modal">
                                                    확인
                                                </button>

                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <button id="retrieval-approval-button" class="btn btn-info" data-toggle="modal"
                                        data-target="#retrievalApprovalModal">출고 승인
                                </button>

                                <!-- 출고 승인 Modal -->
                                <div class="modal fade" id="retrievalApprovalModal" tabindex="-1" role="dialog"
                                     aria-labelledby="retrievalApprovalModalLabel" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="retrievalApprovalModalLabel">출고 승인 확인</h5>
                                                <button type="button" class="close" data-dismiss="modal"
                                                        aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                <h6 style="text-align: center;">출고를 승인하시겠습니까?</h6>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                                                    닫기
                                                </button>
                                                <button type="button" id="confirm-approval-button"
                                                        class="btn btn-primary">승인
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                                <button id="waybill-register-button" class="btn btn-primary" data-toggle="modal"
                                        data-target="#waybillModal">운송장 등록
                                </button>
                                <!-- 운송장 등록 Modal -->
                                <div class="modal fade" id="waybillModal" tabindex="-1" role="dialog"
                                     aria-labelledby="waybillModalLabel" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="waybillModalLabel">운송장 정보</h5>

                                                <button type="button" class="close" data-dismiss="modal"
                                                        aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">

                                                <br>
                                                <h6 style="text-align: center;">운송장을 등록하시겠습니까?</h6>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" id="waybill-confirm-button"
                                                        class="btn btn-secondary" data-dismiss="modal">
                                                    확인
                                                </button>
                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                                                    닫기
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <button id="waybill-print-button" class="btn btn-primary" data-toggle="modal"
                                        data-target="#waybillPrintModal">운송장 출력
                                </button>
                                <!-- 운송장 출력 Modal -->
                                <div class="modal fade" id="waybillPrintModal" tabindex="-1" role="dialog"
                                     aria-labelledby="waybillPrintModalLabel" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="waybillPrintModalLabel">운송장 정보</h5>

                                                <button type="button" class="close" data-dismiss="modal"
                                                        aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">

                                                <br>
                                                <h6 style="text-align: center;">운송장을 출력하시겠습니까?</h6>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" id="waybill-print-confirm-button"
                                                        class="btn btn-secondary" data-dismiss="modal">
                                                    확인
                                                </button>
                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                                                    닫기
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <br>

                        <div class="table-responsive">
                            <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                                <thead>
                                <tr>
                                    <!--                                    <th><input type="checkbox" id="all-check"></th> &lt;!&ndash;체크박스&ndash;&gt;-->
                                    <th style="background-color: #4e73df; color: #fff;"></th>
                                    <th style="background-color: #4e73df; color: #fff;">No.</th>
                                    <th style="background-color: #4e73df; color: #fff;">출고번호</th>
                                    <th style="background-color: #4e73df; color: #fff;">출고 희망일</th>
                                    <th style="background-color: #4e73df; color: #fff;">회원 아이디</th>
                                    <th style="background-color: #4e73df; color: #fff;">제품 아이디</th>
                                    <th style="background-color: #4e73df; color: #fff;">제품 이름</th>
                                    <th style="background-color: #4e73df; color: #fff;">상품 수량</th>
                                    <th style="background-color: #4e73df; color: #fff;">배차</th>
                                    <th style="background-color: #4e73df; color: #fff;">출고 승인</th>
                                    <th style="background-color: #4e73df; color: #fff;">운송장</th>

                                </tr>
                                </thead>

                                <tbody>
                                <!-- DataTables will fill the data here -->
                                </tr>
                                </tbody>

                            </table>
                        </div>

                        <form id="retrieval-list-search" style="margin: 0 auto; width: fit-content;">
                            <div class="col-md-12">
                                <div class="row">
                                    <div class="col-md-5">
                                        <label for="orderDate-input">출고 희망일</label>
                                        <input type="date" id="orderDate-input" class="form-control"/>
                                    </div>
                                    <div class="col-md-3">
                                        <br><br>
                                        <input type="checkbox" id="isAllocated"/>
                                        <label for="isAllocated">배차 여부</label>
                                    </div>
                                    <div class="col-md-3">
                                        <br><br>
                                        <input type="checkbox" id="isApproved"/>
                                        <label for="isApproved">승인 여부</label>
                                    </div>
                                </div>
                            </div>
                            <br>


                            <div class="row">
                                <!-- 1열 -->
                                <select id="retrieval-search-select" class="form-control" style="width: 150px">
                                    <option value="search-all">전체</option>
                                    <option value="search-retrieval-id">출고번호</option>
                                    <option value="search-uid">작성자</option>
                                    <option value="search-productid">제품 아이디</option>
                                    <option value="search-pname">제품명</option>
                                </select>

                                <!-- 2열 -->
                                <input type="text" id="searchInput" name="searchInput" class="form-control"
                                       style="width: 350px"/>

                                <button id="retrieval-search-button" class="btn btn-primary">검색</button>
                            </div>
                        </form>

                    </div>
                </div>
            </div>
            <!-- /.container-fluid -->

        </div>
        <!-- div id = "content" -->
        <th:block th:replace="common/fragments/index :: footer-fragment"></th:block>
    </div>
    <!-- End of Content Wrapper -->

</div>
<!-- End of Page Wrapper -->
<th:block th:replace="common/fragments/index :: scroll-to-top-fragment"></th:block>
<th:block th:replace="common/fragments/index :: logout-modal-fragment"></th:block>
<th:block th:replace="common/fragments/index :: scripts-fragment"></th:block>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.2/xlsx.full.min.js"></script>

<!-- 출고 요청 js 코드 -->
<script th:inline="javascript">
    document.getElementById("retrieval-register-button").addEventListener("click", function () {
        // 사용자가 입력한 값을 가져옴
        var productId = document.getElementById("productId-input").value;
        var quantity = document.getElementById("quantity-input").value;
        var expectedDate = document.getElementById("expectedDate-input").value;
        var postcode = document.getElementById("postcode-input").value;
        var streetNameAddress = document.getElementById("streetNameAddress-input").value;
        var streetNumberAddress = document.getElementById("streetNumberAddress-input").value;
        var detailAddress = document.getElementById("detailAddress-input").value;

        // 데이터를 JSON 형식으로 변환
        var shippingOrderData = {
            expectedDate: expectedDate,
            postcode: postcode,
            streetNameAddress: streetNameAddress,
            streetNumberAddress: streetNumberAddress,
            detailAddress: detailAddress
        };

        var shippingOrderDetailData = {
            productId: productId,
            quantity: quantity
        };

        // 서버에 데이터를 전송
        fetch('/retrieval/registerShippingOrder', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                shippingOrder: shippingOrderData,
                shippingOrderDetail: shippingOrderDetailData
            })
        })
            .then(response => {
                // 서버 응답 처리
                if (response.ok) {
                    // 성공적으로 응답을 받았을 때 할 작업
                    alert("출고 요청이 등록되었습니다.");

                    // 입력 창들의 값을 초기화
                    document.getElementById("productId-input").value = "";
                    document.getElementById("quantity-input").value = "";
                    document.getElementById("expectedDate-input").value = "";
                    document.getElementById("postcode-input").value = "";
                    document.getElementById("streetNameAddress-input").value = "";
                    document.getElementById("streetNumberAddress-input").value = "";
                    document.getElementById("detailAddress-input").value = "";

                    console.log('성공');
                    loadShippingOrdersData();
                } else {
                    // 오류가 발생했을 때 할 작업
                    console.log('실패');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    });

    <!-- 검색 버튼js -->
    document.getElementById("retrieval-search-button").addEventListener("click", function () {
        // 사용자가 선택한 출고 희망일, 배차 여부, 승인 여부를 가져옴
        var orderDate = document.getElementById("orderDate-input").value;
        var isAllocated = document.getElementById("isAllocated").checked;
        var isApproved = document.getElementById("isApproved").checked;

        // 데이터를 JSON 형식으로 변환
        var searchData = {
            orderDate: orderDate,
            isAllocated: isAllocated,
            isApproved: isApproved
        };

        // 서버에 데이터를 전송하여 검색 결과를 요청
        fetch('/retrieval/data', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(searchData)
        })
            .then(response => {
                // 서버 응답 처리
                if (response.ok) {
                    // 검색 결과를 성공적으로 받았을 때 할 작업
                    console.log('검색 결과를 받았습니다.');
                    return response.json();
                } else {
                    // 오류가 발생했을 때 할 작업
                    console.log('검색 결과를 받지 못했습니다.');
                    throw new Error('검색 결과를 받지 못했습니다.');
                }
            })
            .then(data => {
                // 받은 검색 결과를 처리하는 코드
                console.log(data);
                // 여기서는 받은 데이터를 가지고 테이블을 갱신하거나 화면에 표시하는 등의 작업을 수행할 수 있습니다.
            })
            .catch(error => {
                // 오류 처리
                console.error('Error:', error);
            });
    });
    <!-- 검색 버튼 끝 -->

    // 체크박스 중복 선택 방지
    $('#dataTable').on('draw.dt', function () {
        var checkboxes = document.querySelectorAll("#dataTable .check-item");
        checkboxes.forEach(function (checkbox) {
            checkbox.addEventListener('change', function () {
                // 다른 모든 체크박스의 선택을 해제합니다.
                checkboxes.forEach(function (box) {
                    if (box !== checkbox) box.checked = false;
                });
            });
        });
    });


    <!-- 출고 지시서 list js 코드 -->

    /*<![CDATA[*/
    var currentDataTable = "shippingOrders"; // 현재 보고 있는 데이터 타입

    $(document).ready(function () {
        loadShippingOrdersData(); // 초기 페이지 로딩 시 출고 주문 데이터 로드
    });

    $('#button-search').click(function () {
        var searchType = $('#searchType').val();
        var searchKeyword = $('#searchKeyword').val();
        loadShippingOrdersData(searchType, searchKeyword);
    });

    function loadShippingOrdersData(searchType = '', searchKeyword = '') {
        var params = new URLSearchParams({
            searchType: searchType,
            searchKeyword: searchKeyword
        }).toString();

        if ($.fn.DataTable.isDataTable('#dataTable')) {
            $('#dataTable').DataTable().destroy();
        }

        $('#dataTable').DataTable({
            "ajax": {
                "url": `/retrieval/data?${params}`,
                "type": "GET",
                "dataSrc": ""
            },
            "columns": [
                {
                    "data": "id", // 여기에서 'id'는 출고 지시서 ID에 해당하는 데이터 필드입니다.
                    "render": function (data, type, row) {
                        // 체크박스에 data-order-id 속성을 설정하여 출고 지시서 ID를 할당합니다.
                        return "<input type='checkbox' class='check-item' data-order-id='" + data + "'>";
                    }
                },
                {
                    "data": null, "render": function (data, type, row, meta) {
                        return meta.row + 1;
                    }
                }, // 글 번호 추가
                {
                    "data": "id",
                    "render": function (data, type, row) {
                        return '<a href="/retrieval/shippingorder/' + data + '" class="shipping-order-link">' + data + '</a>';
                    }
                }, // 출고번호에 링크 추가
                {"data": "expectedDate"},
                {"data": "uid"}, // 회원 아이디 추가
                {"data": "productId"}, // 제품 아이디 추가
                {"data": "productName"},
                {"data": "quantity"},
                {
                    "data": "allocatedStatus",
                    "render": function (data) {
                        switch (data) {
                            case 0:
                                return "대기";
                            case 1:
                                return "완료";
                            case 2:
                                return "취소";
                            default:
                                return "알 수 없음"; // 예상치 못한 값에 대한 처리
                        }
                    }
                },
                {
                    "data": "approvedStatus",
                    "render": function (data) {
                        switch (data) {
                            case 0:
                                return "대기";
                            case 1:
                                return "완료";
                            case 2:
                                return "취소";
                            default:
                                return "알 수 없음";
                        }
                    }
                },
                {
                    "data": "waybillStatus",
                    "render": function (data) {
                        switch (data) {
                            case 0:
                                return "미등록";
                            case 1:
                                return "등록";
                            case 2:
                                return "등록 취소";
                            default:
                                return "알 수 없음";
                        }
                    }
                }
            ],
            "searching": false,
            "paging": true,
            "ordering": true,
            "info": true,
            "pageLength": 10
        });
    }

    /*]]>*/


    /*    <!-- 체크박스 전체선택 js -->
        // 페이지 로드 시 실행되는 함수
        document.addEventListener("DOMContentLoaded", function () {
            // 전체 선택 체크박스 클릭 이벤트 등록
            document.getElementById("all-check").addEventListener("change", function () {
                // 모든 아래 체크박스에 선택 속성 적용
                var checkboxes = document.querySelectorAll(".check-item");
                checkboxes.forEach(function (checkbox) {
                    checkbox.checked = event.target.checked;
                });
            });
        });*/

    // '배차 관리' 버튼 이벤트 리스너
    document.getElementById("vehicle-allocation-button").addEventListener("click", function () {
        // 체크된 체크박스의 데이터 수집
        var checkedBoxes = document.querySelectorAll("#dataTable .check-item:checked");
        var selectedOrders = Array.from(checkedBoxes).map(box => box.getAttribute("data-order-id"));

        if (selectedOrders.length === 0) {
            alert("출고 지시서를 선택해주세요.");
            window.location.reload(); // 페이지를 새로 고침하여 메인 페이지로 돌아갑니다.
            //return;
        }

        // 첫 번째 선택된 출고 지시서 ID를 사용 (이 예제에서는 하나의 선택만 처리)
        var selectedOrderId = selectedOrders[0];

        // 선택된 출고 지시서 ID를 사용하여 배차 가능한 차량 목록 조회
        fetchVehicles(selectedOrderId);
    });

    function fetchVehicles(orderId) {
        // 서버에 배차 가능한 차량 목록 요청
        fetch(`/retrieval/managedispatch?orderId=${orderId}`)
            .then(response => response.json())
            .then(data => {
                // 모달에 차량 목록 표시 로직
                showVehiclesInModal(data);
            })
            .catch(error => console.error('Error:', error));
    }

    // 모달에 차량 목록 표시 함수
    function showVehiclesInModal(vehicles) {
        const modalBody = document.querySelector("#vehicleAllocationModal .modal-body");
        modalBody.innerHTML = ''; // 모달 내용 초기화

        const select = document.createElement("select");
        select.id = "vehicleSelection";
        select.className = "form-control";

        vehicles.forEach(vehicle => {
            const option = document.createElement("option");
            option.value = vehicle.num;
            option.textContent = `${vehicle.type}-${vehicle.num}-(${vehicle.dname}, ${vehicle.dphone})`; // 예시: 타입-차량 번호-(전자 이름, 운전자 전화번호)
            select.appendChild(option);
        });

        modalBody.appendChild(select);
    }

    // 배차가 확정된 후 DataTables를 새로고침하는 함수
    function refreshDataTable() {
        $('#dataTable').DataTable().ajax.reload(null, false); // 캐시된 데이터 없이 테이블을 새로고침
    }


    // 차량 선택 처리 함수 구현
    function selectVehicle(vehicleNum) {
        // 선택된 차량 번호를 사용하여 추가 작업 수행
        // 예를 들어, 배차 확정 API 호출 등
        console.log(`선택된 차량 번호: ${vehicleNum}`);
        // 실제 배차 확정을 위한 API 호출 로직 구현
    }

    // 선택된 차량의 번호를 저장할 변수
    let selectedVehicleNum;

    // 모달에서 차량을 선택할 때의 이벤트 처리
    document.querySelector("#vehicleAllocationModal .modal-body").addEventListener("click", function (event) {
        if (event.target.classList.contains("vehicle-item")) {
            selectedVehicleNum = event.target.getAttribute("data-num");
            // 선택된 차량 번호를 표시하거나 다른 처리를 할 수 있습니다.
        }
    });

    // '선택' 버튼 클릭 이벤트 처리
    document.getElementById("choose-vehicle-button").addEventListener("click", function () {
        // 선택된 차량 번호
        const selectedVehicleNum = document.getElementById("vehicleSelection").value;

        // 체크된 출고 지시서의 ID를 찾습니다.
        var checkedOrderBox = document.querySelector("#dataTable .check-item:checked");
        var shippingOrdersId = checkedOrderBox ? checkedOrderBox.getAttribute("data-order-id") : null;

        if (!shippingOrdersId || !selectedVehicleNum) {
            alert("출고 지시서와 차량을 선택해주세요.");
            //return;
        }

        // 서버에 배차 확정 요청을 보냅니다.
        confirmDispatch(shippingOrdersId, selectedVehicleNum);
    });

    function confirmDispatch(shippingOrdersId, vehicleNum) {
        fetch('/retrieval/confirmdispatch', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                dispatch: {
                    shippingOrdersId: shippingOrdersId,
                    vehicleNum: vehicleNum
                }
            })
        })
            .then(response => {
                if (response.ok) {
                    alert("배차가 확정되었습니다.");
                    refreshDataTable(); // DataTables 새로고침 호출
                    window.location.reload(); // 페이지를 새로 고침하여 업데이트된 상태를 표시합니다.
                    //return;
                } else {
                    alert("배차 확정에 실패했습니다.");
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("배차 요청 중 오류가 발생했습니다.");
            });
    }

    // '출고 승인' 버튼 클릭 이벤트 리스너
    document.getElementById("retrieval-approval-button").addEventListener("click", function () {
        var checkedOrderBox = document.querySelector("#dataTable .check-item:checked");
        if (!checkedOrderBox) {
            alert("출고 지시서를 선택해주세요.");
            window.location.reload(); // 페이지를 새로 고침하여 메인 페이지로 돌아갑니다.
            //return;
        }

        // 체크된 출고 지시서의 ID를 찾습니다.
        var checkedOrderBox = document.querySelector("#dataTable .check-item:checked");
        var shippingOrdersId = checkedOrderBox ? checkedOrderBox.getAttribute("data-order-id") : null;
        console.log("출고지시서 아이디 : " + shippingOrdersId);

        // 서버에서 allocated_status를 확인하는 요청
        fetch(`/retrieval/approveretrieval/${shippingOrdersId}`)
            .then(response => response.json())
            .then(data => {
                // allocated_status가 0인 경우 메시지 표시
                if (data.allocatedStatus === 0) {
                    alert("먼저 배차 지정을 해주십시오.");
                    window.location.reload();
                    //return;
                } else {
                    // 출고 승인 확인 모달 표시
                    $('#retrievalApprovalModal').modal('show');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // alert("출고 승인 요청 중 오류가 발생했습니다.");
            });
    });

    // 출고 승인 모달에서 '승인' 버튼 클릭 이벤트
    document.getElementById("confirm-approval-button").addEventListener("click", function () {
        // 출고 승인 로직 수행
        var checkedOrderBox = document.querySelector("#dataTable .check-item:checked");
        var shippingOrdersId = checkedOrderBox.getAttribute("data-order-id");

        // 출고 승인 요청
        confirmRetrieval(shippingOrdersId);
    });

    function confirmRetrieval(shippingOrdersId) {
        fetch('/retrieval/confirmretrieval', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                retrieval: {
                    shippingOrdersId: shippingOrdersId,
                    approvedStatus: 1 // 승인 상태로 설정
                }
            })
        })
            .then(response => {
                if (response.ok) {
                    alert("출고가 승인되었습니다.");
                    window.location.reload(); // 페이지를 새로 고침하여 메인 페이지로 돌아갑니다.
                    //return;
                } else {
                    alert("출고 승인에 실패했습니다.");
                    closeModalAndRefresh(); // 승인 모달 닫기 및 페이지 새로 고침 함수 호출
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("출고 승인 요청 중 오류가 발생했습니다.");
                closeModalAndRefresh(); // 승인 모달 닫기 및 페이지 새로 고침 함수 호출
            });
    }

    // 모달 닫기 및 페이지 새로 고침 함수
    function closeModalAndRefresh() {
        $('#retrievalApprovalModal').modal('hide');
        window.location.reload(); // 페이지를 새로 고침하여 메인 페이지로 돌아갑니다.
    }

    // 출고 승인 모달에서 '닫기' 버튼 클릭 이벤트
    document.getElementById("close-approval-modal").addEventListener("click", function () {
        $('#retrievalApprovalModal').modal('hide');
    });
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.2/xlsx.full.min.js"></script>

<!-- 출고 요청 js 코드 -->
<script th:inline="javascript">
    document.getElementById("retrieval-register-button").addEventListener("click", function () {
        // 사용자가 입력한 값을 가져옴
        var productId = document.getElementById("productId-input").value;
        var quantity = document.getElementById("quantity-input").value;
        var expectedDate = document.getElementById("expectedDate-input").value;
        var postcode = document.getElementById("postcode-input").value;
        var streetNameAddress = document.getElementById("streetNameAddress-input").value;
        var streetNumberAddress = document.getElementById("streetNumberAddress-input").value;
        var detailAddress = document.getElementById("detailAddress-input").value;

        // 데이터를 JSON 형식으로 변환
        var shippingOrderData = {
            expectedDate: expectedDate,
            postcode: postcode,
            streetNameAddress: streetNameAddress,
            streetNumberAddress: streetNumberAddress,
            detailAddress: detailAddress
        };

        var shippingOrderDetailData = {
            productId: productId,
            quantity: quantity
        };

        // 서버에 데이터를 전송
        fetch('/retrieval/registerShippingOrder', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                shippingOrder: shippingOrderData,
                shippingOrderDetail: shippingOrderDetailData
            })
        })
            .then(response => {
                // 서버 응답 처리
                if (response.ok) {
                    // 성공적으로 응답을 받았을 때 할 작업
                    alert("출고 요청이 등록되었습니다.");

                    // 입력 창들의 값을 초기화
                    document.getElementById("productId-input").value = "";
                    document.getElementById("quantity-input").value = "";
                    document.getElementById("expectedDate-input").value = "";
                    document.getElementById("postcode-input").value = "";
                    document.getElementById("streetNameAddress-input").value = "";
                    document.getElementById("streetNumberAddress-input").value = "";
                    document.getElementById("detailAddress-input").value = "";

                    console.log('성공');
                    loadShippingOrdersData();
                } else {
                    // 오류가 발생했을 때 할 작업
                    console.log('실패');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    });

    <!-- 검색 버튼js -->
    document.getElementById("retrieval-search-button").addEventListener("click", function () {
        // 사용자가 선택한 출고 희망일, 배차 여부, 승인 여부를 가져옴
        var orderDate = document.getElementById("orderDate-input").value;
        var isAllocated = document.getElementById("isAllocated").checked;
        var isApproved = document.getElementById("isApproved").checked;

        // 데이터를 JSON 형식으로 변환
        var searchData = {
            orderDate: orderDate,
            isAllocated: isAllocated,
            isApproved: isApproved
        };

        // 서버에 데이터를 전송하여 검색 결과를 요청
        fetch('/retrieval/data', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(searchData)
        })
            .then(response => {
                // 서버 응답 처리
                if (response.ok) {
                    // 검색 결과를 성공적으로 받았을 때 할 작업
                    console.log('검색 결과를 받았습니다.');
                    return response.json();
                } else {
                    // 오류가 발생했을 때 할 작업
                    console.log('검색 결과를 받지 못했습니다.');
                    throw new Error('검색 결과를 받지 못했습니다.');
                }
            })
            .then(data => {
                // 받은 검색 결과를 처리하는 코드
                console.log(data);
                // 여기서는 받은 데이터를 가지고 테이블을 갱신하거나 화면에 표시하는 등의 작업을 수행할 수 있습니다.
            })
            .catch(error => {
                // 오류 처리
                console.error('Error:', error);
            });
    });
    <!-- 검색 버튼 끝 -->

    // 체크박스 중복 선택 방지
    $('#dataTable').on('draw.dt', function () {
        var checkboxes = document.querySelectorAll("#dataTable .check-item");
        checkboxes.forEach(function (checkbox) {
            checkbox.addEventListener('change', function () {
                // 다른 모든 체크박스의 선택을 해제합니다.
                checkboxes.forEach(function (box) {
                    if (box !== checkbox) box.checked = false;
                });
            });
        });
    });


    <!-- 출고 지시서 list js 코드 -->

    /*<![CDATA[*/
    var currentDataTable = "shippingOrders"; // 현재 보고 있는 데이터 타입

    $(document).ready(function () {
        loadShippingOrdersData(); // 초기 페이지 로딩 시 출고 주문 데이터 로드
    });

    $('#button-search').click(function () {
        var searchType = $('#searchType').val();
        var searchKeyword = $('#searchKeyword').val();
        loadShippingOrdersData(searchType, searchKeyword);
    });

    function loadShippingOrdersData(searchType = '', searchKeyword = '') {
        var params = new URLSearchParams({
            searchType: searchType,
            searchKeyword: searchKeyword
        }).toString();

        if ($.fn.DataTable.isDataTable('#dataTable')) {
            $('#dataTable').DataTable().destroy();
        }

        $('#dataTable').DataTable({
            "ajax": {
                "url": `/retrieval/data?${params}`,
                "type": "GET",
                "dataSrc": ""
            },
            "columns": [
                {
                    "data": "id", // 여기에서 'id'는 출고 지시서 ID에 해당하는 데이터 필드입니다.
                    "render": function (data, type, row) {
                        // 체크박스에 data-order-id 속성을 설정하여 출고 지시서 ID를 할당합니다.
                        return "<input type='checkbox' class='check-item' data-order-id='" + data + "'>";
                    }
                },
                {
                    "data": null, "render": function (data, type, row, meta) {
                        return meta.row + 1;
                    }
                }, // 글 번호 추가
                {
                    "data": "id",
                    "render": function (data, type, row) {
                        return '<a href="/retrieval/shippingorder/' + data + '" class="shipping-order-link">' + data + '</a>';
                    }
                }, // 출고번호에 링크 추가
                {"data": "expectedDate"},
                {"data": "uid"}, // 회원 아이디 추가
                {"data": "productId"}, // 제품 아이디 추가
                {"data": "productName"},
                {"data": "quantity"},
                {"data": "allocatedStatus"},
                {"data": "approvedStatus"},
                {"data": "waybillStatus"}
            ],
            "searching": false,
            "paging": true,
            "ordering": true,
            "info": true,
            "pageLength": 10
        });
    }

    /*]]>*/


    /*    <!-- 체크박스 전체선택 js -->
        // 페이지 로드 시 실행되는 함수
        document.addEventListener("DOMContentLoaded", function () {
            // 전체 선택 체크박스 클릭 이벤트 등록
            document.getElementById("all-check").addEventListener("change", function () {
                // 모든 아래 체크박스에 선택 속성 적용
                var checkboxes = document.querySelectorAll(".check-item");
                checkboxes.forEach(function (checkbox) {
                    checkbox.checked = event.target.checked;
                });
            });
        });*/

    // '배차 관리' 버튼 이벤트 리스너
    document.getElementById("vehicle-allocation-button").addEventListener("click", function () {
        // 체크된 체크박스의 데이터 수집
        var checkedBoxes = document.querySelectorAll("#dataTable .check-item:checked");
        var selectedOrders = Array.from(checkedBoxes).map(box => box.getAttribute("data-order-id"));

        if (selectedOrders.length === 0) {
            alert("출고 지시서를 선택해주세요.");
            window.location.reload(); // 페이지를 새로 고침하여 메인 페이지로 돌아갑니다.
            //return;
        }

        // 첫 번째 선택된 출고 지시서 ID를 사용 (이 예제에서는 하나의 선택만 처리)
        var selectedOrderId = selectedOrders[0];

        // 선택된 출고 지시서 ID를 사용하여 배차 가능한 차량 목록 조회
        fetchVehicles(selectedOrderId);
    });

    function fetchVehicles(orderId) {
        // 서버에 배차 가능한 차량 목록 요청
        fetch(`/retrieval/managedispatch?orderId=${orderId}`)
            .then(response => response.json())
            .then(data => {
                // 모달에 차량 목록 표시 로직
                showVehiclesInModal(data);
            })
            .catch(error => console.error('Error:', error));
    }

    // 모달에 차량 목록 표시 함수
    function showVehiclesInModal(vehicles) {
        const modalBody = document.querySelector("#vehicleAllocationModal .modal-body");
        modalBody.innerHTML = ''; // 모달 내용 초기화

        const select = document.createElement("select");
        select.id = "vehicleSelection";
        select.className = "form-control";

        vehicles.forEach(vehicle => {
            const option = document.createElement("option");
            option.value = vehicle.num;
            option.textContent = `${vehicle.type}-${vehicle.num}-(${vehicle.dname}, ${vehicle.dphone})`; // 예시: 타입-차량 번호-(전자 이름, 운전자 전화번호)
            select.appendChild(option);
        });

        modalBody.appendChild(select);
    }

    // 배차가 확정된 후 DataTables를 새로고침하는 함수
    function refreshDataTable() {
        $('#dataTable').DataTable().ajax.reload(null, false); // 캐시된 데이터 없이 테이블을 새로고침
    }


    // 차량 선택 처리 함수 구현
    function selectVehicle(vehicleNum) {
        // 선택된 차량 번호를 사용하여 추가 작업 수행
        // 예를 들어, 배차 확정 API 호출 등
        console.log(`선택된 차량 번호: ${vehicleNum}`);
        // 실제 배차 확정을 위한 API 호출 로직 구현
    }

    // 선택된 차량의 번호를 저장할 변수
    let selectedVehicleNum;

    // 모달에서 차량을 선택할 때의 이벤트 처리
    document.querySelector("#vehicleAllocationModal .modal-body").addEventListener("click", function (event) {
        if (event.target.classList.contains("vehicle-item")) {
            selectedVehicleNum = event.target.getAttribute("data-num");
            // 선택된 차량 번호를 표시하거나 다른 처리를 할 수 있습니다.
        }
    });

    // '선택' 버튼 클릭 이벤트 처리
    document.getElementById("choose-vehicle-button").addEventListener("click", function () {
        // 선택된 차량 번호
        const selectedVehicleNum = document.getElementById("vehicleSelection").value;

        // 체크된 출고 지시서의 ID를 찾습니다.
        var checkedOrderBox = document.querySelector("#dataTable .check-item:checked");
        var shippingOrdersId = checkedOrderBox ? checkedOrderBox.getAttribute("data-order-id") : null;

        if (!shippingOrdersId || !selectedVehicleNum) {
            alert("출고 지시서와 차량을 선택해주세요.");
            //return;
        }

        // 서버에 배차 확정 요청을 보냅니다.
        confirmDispatch(shippingOrdersId, selectedVehicleNum);
    });

    function confirmDispatch(shippingOrdersId, vehicleNum) {
        fetch('/retrieval/confirmdispatch', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                dispatch: {
                    shippingOrdersId: shippingOrdersId,
                    vehicleNum: vehicleNum
                }
            })
        })
            .then(response => {
                if (response.ok) {
                    alert("배차가 확정되었습니다.");
                    refreshDataTable(); // DataTables 새로고침 호출
                    window.location.reload(); // 페이지를 새로 고침하여 업데이트된 상태를 표시합니다.
                    //return;
                } else {
                    alert("배차 확정에 실패했습니다.");
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("배차 요청 중 오류가 발생했습니다.");
            });
    }

    // '출고 승인' 버튼 클릭 이벤트 리스너
    document.getElementById("retrieval-approval-button").addEventListener("click", function () {
        var checkedOrderBox = document.querySelector("#dataTable .check-item:checked");
        if (!checkedOrderBox) {
            alert("출고 지시서를 선택해주세요.");
            window.location.reload(); // 페이지를 새로 고침하여 메인 페이지로 돌아갑니다.
            //return;
        }

        // 체크된 출고 지시서의 ID를 찾습니다.
        var checkedOrderBox = document.querySelector("#dataTable .check-item:checked");
        var shippingOrdersId = checkedOrderBox ? checkedOrderBox.getAttribute("data-order-id") : null;
        console.log("출고지시서 아이디 : " + shippingOrdersId);

        // 서버에서 allocated_status를 확인하는 요청
        fetch(`/retrieval/approveretrieval/${shippingOrdersId}`)
            .then(response => response.json())
            .then(data => {
                // allocated_status가 0인 경우 메시지 표시
                if (data.allocatedStatus === 0) {
                    alert("먼저 배차 지정을 해주십시오.");
                    window.location.reload();
                    //return;
                } else {
                    // 출고 승인 확인 모달 표시
                    $('#retrievalApprovalModal').modal('show');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // alert("출고 승인 요청 중 오류가 발생했습니다.");
            });
    });

    // 출고 승인 모달에서 '승인' 버튼 클릭 이벤트
    document.getElementById("confirm-approval-button").addEventListener("click", function () {
        // 출고 승인 로직 수행
        var checkedOrderBox = document.querySelector("#dataTable .check-item:checked");
        var shippingOrdersId = checkedOrderBox.getAttribute("data-order-id");

        // 출고 승인 요청
        confirmRetrieval(shippingOrdersId);
    });

    function confirmRetrieval(shippingOrdersId) {
        fetch('/retrieval/confirmretrieval', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                retrieval: {
                    shippingOrdersId: shippingOrdersId,
                    approvedStatus: 1 // 승인 상태로 설정
                }
            })
        })
            .then(response => {
                if (response.ok) {
                    alert("출고가 승인되었습니다.");
                    window.location.reload(); // 페이지를 새로 고침하여 메인 페이지로 돌아갑니다.
                    //return;
                } else {
                    alert("출고 승인에 실패했습니다.");
                    closeModalAndRefresh(); // 승인 모달 닫기 및 페이지 새로 고침 함수 호출
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("출고 승인 요청 중 오류가 발생했습니다.");
                closeModalAndRefresh(); // 승인 모달 닫기 및 페이지 새로 고침 함수 호출
            });
    }

    // 모달 닫기 및 페이지 새로 고침 함수
    function closeModalAndRefresh() {
        $('#retrievalApprovalModal').modal('hide');
        window.location.reload(); // 페이지를 새로 고침하여 메인 페이지로 돌아갑니다.
    }

    // 출고 승인 모달에서 '닫기' 버튼 클릭 이벤트
    document.getElementById("close-approval-modal").addEventListener("click", function () {
        $('#retrievalApprovalModal').modal('hide');
    });
</script>
<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function() {
        // '운송장 등록' 버튼 클릭 이벤트
        document.getElementById("waybill-register-button").addEventListener("click", function() {
            var checkedOrderBox = document.querySelector("#dataTable .check-item:checked");
            if (!checkedOrderBox) {
                alert("출고 지시서를 선택해주세요.");
                window.location.reload();
            }

            var shippingOrdersId = checkedOrderBox.getAttribute("data-order-id");
            fetch(`/retrieval/registerwaybill/${shippingOrdersId}`)
                .then(response => response.json())
                .then(data => {
                    var approvedStatus = data.approvedStatus;
                    if (approvedStatus === 0) {
                        alert("출고 승인을 먼저 받아주세요.");
                        window.location.reload();
                    } else {
                        // '운송장 등록' 확인 모달을 보여주고 '확인' 버튼에 이벤트 리스너를 추가합니다.
                        $('#waybillModal').modal('show');
                        document.getElementById("waybill-confirm-button").addEventListener("click", function() {
                            var requestData = { shippingOrdersId: shippingOrdersId };
                            fetch('/retrieval/confirmwaybill', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    waybill: {
                                        shippingOrdersId : shippingOrdersId
                                    }
                                })
                            })
                                .then(response => {
                                    if (response.ok) {
                                        alert("운송장이 등록되었습니다.");
                                        location.reload(); // 페이지 새로고침
                                    } else {
                                        alert("운송장 등록에 실패했습니다.");
                                    }
                                })
                                .catch(error => console.error('Error:', error));
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("서버 통신 중 오류가 발생했습니다.");
                });
        });
    });

</script>
<script th:inline="javascript">
    // 운송장 출력 버튼 클릭 이벤트
    document.getElementById('waybill-print-button').addEventListener('click', function() {
        var checkedOrderBox = document.querySelector("#dataTable .check-item:checked");
        var shippingOrdersId = checkedOrderBox.getAttribute("data-order-id");

        // 운송장 출력 요청
        confirmPrintWaybill(shippingOrdersId);
    });

    function  confirmPrintWaybill(shippingOrdersId) {
        fetch('/retrieval/confirmprintwaybill', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                    waybillPrint: { shippingOrdersId: shippingOrdersId }
                }
            ) // 예시로 검색 필터를 제공합니다. 필요에 따라 수정하세요.
        })
            .then(response => response.json())
            .then(data => {
                // 데이터를 엑셀 파일로 변환
                var worksheet = XLSX.utils.json_to_sheet([data]);
                var workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "야옹창고_운송장");

                // 엑셀 파일 다운로드
                XLSX.writeFile(workbook, "야옹창고_운송장.xlsx");
            })
            .catch(error => console.error('Error:', error));
    }


</script>


</body>

</html>